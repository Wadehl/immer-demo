# ä½¿ç”¨ Immer å®ç°è®°å½•çŠ¶æ€ç®¡ç†

## ä»‹ç»

### ä¸å¯å˜çŠ¶æ€ï¼ˆImmutable Stateï¼‰

ä¸å¯å˜çŠ¶æ€ï¼ˆImmutable Stateï¼‰æ˜¯ä¸€ç§çŠ¶æ€ç®¡ç†æ–¹å¼ï¼Œå®ƒé€šè¿‡åˆ›å»ºæ–°çš„çŠ¶æ€å¯¹è±¡æ¥æ›´æ–°çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ç°æœ‰çš„çŠ¶æ€å¯¹è±¡ã€‚è¿™ç§æ–¹å¼å¯ä»¥é¿å…çŠ¶æ€çš„çªå˜ï¼Œä»è€Œæ›´å®¹æ˜“è¿½è¸ªçŠ¶æ€çš„å˜åŒ–ã€‚

### Immer æ˜¯ä»€ä¹ˆ
> [Immer å®˜ç½‘](https://immerjs.github.io/immer/zh-CN/)

Immer æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†çŠ¶æ€çš„åº“ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´æ–¹ä¾¿åœ°ç®¡ç†çŠ¶æ€ã€‚
ä»–åŸºäº Proxy å®ç°ï¼Œèƒ½å¤Ÿé€šè¿‡ç®€å•çš„ API å®ç°ä¸å¯å˜çŠ¶æ€çš„ç®¡ç†ã€‚

## ğŸ¯ å››ç§çŠ¶æ€ç®¡ç†å®ç°æ–¹å¼å¯¹æ¯”

æœ¬é¡¹ç›®å±•ç¤ºäº†å››ç§ä¸åŒçš„çŠ¶æ€å†å²ç®¡ç†æ–¹å¼ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼š

### 1. æ‰‹åŠ¨æ ˆç®¡ç† (Manual Stack)
- âœ‹ **å®Œå…¨æ‰‹åŠ¨** - è‡ªå·±å®ç°æ·±æ‹·è´å’Œæ ˆæ“ä½œ
- ğŸ”§ **é€‚ç”¨åœºæ™¯** - å­¦ä¹ ä¸å¯å˜æ€§æ¦‚å¿µï¼Œå°å‹é¡¹ç›®
- ğŸ“Š **æ€§èƒ½** - æ·±æ‹·è´å¼€é”€ï¼Œä½†é€»è¾‘ç®€å•
- ğŸ’¾ **å†…å­˜** - å­˜å‚¨å®Œæ•´çŠ¶æ€å¿«ç…§

### 2. Immeræ ˆç®¡ç† (Immer Stack)
- ğŸš€ **Immer + æ‰‹åŠ¨æ ˆ** - è‡ªåŠ¨ä¸å¯å˜æ€§ + æ‰‹åŠ¨å†å²ç®¡ç†
- ğŸ”§ **é€‚ç”¨åœºæ™¯** - éœ€è¦Immerä¾¿åˆ©æ€§ä½†å¸Œæœ›æ§åˆ¶å†å²é€»è¾‘
- ğŸ“Š **æ€§èƒ½** - Immerå¼€é”€ + çŠ¶æ€å¿«ç…§å­˜å‚¨
- ğŸ’¾ **å†…å­˜** - å­˜å‚¨å®Œæ•´çŠ¶æ€å¿«ç…§ + patchesä¿¡æ¯

### 3. Patchç®¡ç† (Patch History)
- ğŸ”§ **Patché‡æ”¾** - åªå­˜å‚¨patchesï¼Œé€šè¿‡é‡æ”¾è®¡ç®—å½“å‰çŠ¶æ€
- ğŸ”§ **é€‚ç”¨åœºæ™¯** - å†…å­˜æ•æ„Ÿï¼Œç®€å•çŠ¶æ€ç»“æ„
- ğŸ“Š **æ€§èƒ½** - é‡æ–°è®¡ç®—å¼€é”€O(n)ï¼Œä½†patcheså°
- ğŸ’¾ **å†…å­˜** - æœ€ä¼˜ - åªå­˜å‚¨patches

### 4. Direct Patchç®¡ç† (Direct Patch) â­ **æ–°å¢**
- âš¡ **é«˜æ€§èƒ½ç‰ˆæœ¬** - ç›´æ¥çŠ¶æ€å­˜å‚¨ + InversePatches
- ğŸ”§ **é€‚ç”¨åœºæ™¯** - é«˜é¢‘è®¿é—®ï¼Œå®æ—¶åº”ç”¨ï¼Œå¤æ‚çŠ¶æ€
- ğŸ“Š **æ€§èƒ½** - æœ€ä¼˜ - O(1)è®¿é—®ï¼ŒO(1) undo/redo
- ğŸ’¾ **å†…å­˜** - åŒå€patcheså­˜å‚¨ï¼Œä½†çŠ¶æ€è®¿é—®æå¿«

## ğŸ” InversePatches çš„ä½œç”¨

### ä»€ä¹ˆæ—¶å€™éœ€è¦ InversePatchesï¼Ÿ

**Direct Patchç®¡ç†**å±•ç¤ºäº†`inversePatches`çš„çœŸæ­£ä»·å€¼ï¼š

```typescript
// Undo: ç›´æ¥åº”ç”¨ InversePatches  
const undo = () => {
  const inversePatches = patchHistory.inversePatches[currentIndex]
  currentState = applyPatches(currentState, inversePatches)
  currentIndex--
}

// Redo: ç›´æ¥åº”ç”¨ Patches
const redo = () => {
  currentIndex++  
  const patches = patchHistory.patches[currentIndex]
  currentState = applyPatches(currentState, patches)
}
```

**å…³é”®ä¼˜åŠ¿ï¼š**
- âœ… **O(1)æ€§èƒ½** - æ— éœ€é‡æ–°è®¡ç®—æ•´ä¸ªå†å²
- âœ… **å®æ—¶å“åº”** - é€‚åˆé«˜é¢‘undo/redoæ“ä½œ
- âœ… **å¤æ‚çŠ¶æ€å‹å¥½** - å¤§å‹æ•°æ®ç»“æ„ä¸‹æ•ˆæœæ˜¾è‘—

### ä½¿ç”¨ Immer å®ç° Undo/Redo çš„çŠ¶æ€ç®¡ç†

ä½¿ç”¨ Immer å®ç° Undo/Redo çš„çŠ¶æ€ç®¡ç†ï¼Œéœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

#### 1. åŸºæœ¬æ¦‚å¿µ

**Patch**: Immer ä¸­è¡¨ç¤ºçŠ¶æ€å˜åŒ–çš„å¯¹è±¡ï¼ŒåŒ…å«æ“ä½œç±»å‹ï¼ˆadd/replace/removeï¼‰ã€è·¯å¾„å’Œå€¼ã€‚

**InversePatch**: ç”¨äºæ’¤é”€æ“ä½œçš„é€†å‘patchï¼Œå¯ä»¥å°†çŠ¶æ€å›é€€åˆ°å˜åŒ–å‰ã€‚

**State History**: ç®¡ç†çŠ¶æ€å†å²çš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬è¿‡å»çŠ¶æ€ã€å½“å‰çŠ¶æ€å’Œæœªæ¥çŠ¶æ€ã€‚

#### 2. å®ç°æ–¹å¼é€‰æ‹©

æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼ï¼š

- **å­¦ä¹ ç›®çš„** â†’ æ‰‹åŠ¨æ ˆç®¡ç†
- **ä¸€èˆ¬åº”ç”¨** â†’ Patchç®¡ç†  
- **é«˜æ€§èƒ½éœ€æ±‚** â†’ Direct Patchç®¡ç†
- **æ··åˆéœ€æ±‚** â†’ Immeræ ˆç®¡ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

## ğŸ“š ç›¸å…³èµ„æº

- [Immer å®˜æ–¹æ–‡æ¡£](https://immerjs.github.io/immer/)
- [Vue 3 å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [ä¸å¯å˜æ€§æ¦‚å¿µè¯¦è§£](https://github.com/immutable-js/immutable-js)
